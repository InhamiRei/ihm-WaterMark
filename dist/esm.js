!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.createPoster=e():t.createPoster=e()}(window,(function(){return function(t){var e={};function r(a){if(e[a])return e[a].exports;var i=e[a]={i:a,l:!1,exports:{}};return t[a].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(a,i,function(e){return t[e]}.bind(null,i));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);class a{constructor(t){if(!t||!t.container)throw new Error("The 'container' parameter is required and must be a valid DOM element.");if(e=t.container,!("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName))throw new Error("The 'container' parameter must be a valid DOM element.");var e;this.params={container:t.container,width:250,height:150,fontSize:20,font:"microsoft yahei",color:"#cccccc",content:"watermark",image:null,rotate:-30,zIndex:1e3,opacity:.5,x:null,y:null,gap:[0,0],...t},Array.isArray(this.params.gap)&&2===this.params.gap.length||(this.params.gap=[0,0]),this.params.x=null!==this.params.x&&void 0!==this.params.x?this.params.x:this.params.width/2,this.params.y=null!==this.params.y&&void 0!==this.params.y?this.params.y:this.params.height/2,this.styleStrPromise=this.generateStyle(),this.styleStr="",this.containerObserver=new MutationObserver(this.handleContainerMutations.bind(this)),this.watermarkObserver=new MutationObserver(this.handleWatermarkMutations.bind(this)),this.styleStrPromise.then(t=>{this.styleStr=t})}async generateStyle(){const t=this.params.width+this.params.gap[0],e=this.params.height+this.params.gap[1],r=await Promise.resolve(this.toDataURL());return`\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      z-index: ${this.params.zIndex};\n      pointer-events: none;\n      background-repeat: repeat;\n      background-size: ${t}px ${e}px;\n      background-image: url('${r}');\n    `}toDataURL(){const{width:t,height:e,fontSize:r,font:a,color:i,rotate:s,content:n,opacity:o,x:h,y:l,gap:m,image:p}=this.params,c=document.createElement("canvas");c.width=t+m[0],c.height=e+m[1];const u=c.getContext("2d");return u?(u.clearRect(0,0,c.width,c.height),u.textBaseline="top",u.textAlign="left",u.fillStyle=i,u.globalAlpha=o,u.font=`${r}px ${a}`,p?new Promise(e=>{const m=new Image;m.crossOrigin="anonymous",m.onload=()=>{const r=m.width/m.height,a=Math.min(.8*t,m.width),i=a/r;u.restore(),u.save(),u.translate(h,l),u.rotate(Math.PI/180*s),u.drawImage(m,-a/2,-i/2,a,i),u.restore(),e(c.toDataURL())},m.onerror=()=>{u.clearRect(0,0,c.width,c.height),u.textBaseline="top",u.textAlign="left",u.fillStyle=i,u.globalAlpha=o,u.font=`${r}px ${a}`,this.renderTextWatermark(u,n,h,l,r),e(c.toDataURL())},m.src=p}):(this.renderTextWatermark(u,n,h,l,r),c.toDataURL())):""}renderTextWatermark(t,e,r,a,i){if(t.save(),t.setTransform(1,0,0,1,0,0),t.translate(r,a),t.rotate(Math.PI/180*this.params.rotate),Array.isArray(e)){const r=1.5*i,a=-(r*(e.length-1))/2;e.forEach((e,i)=>{const s=a+r*i;t.fillText(e,-t.measureText(e).width/2,s)})}else t.fillText(e,-t.measureText(e).width/2,-i/2);t.restore()}getOrCreateWatermarkDom(){let t=this.params.container.querySelector(".ihm-watermark");return t||(t=document.createElement("div"),t.setAttribute("class","ihm-watermark"),this.params.container.style.position="relative",this.params.container.insertBefore(t,this.params.container.firstChild),this.watermarkObserver.observe(t,{attributes:!0,childList:!0,subtree:!0})),t}async updateWatermarkStyle(){const t=this.getOrCreateWatermarkDom(),e=t.getAttribute("style");this.styleStr||(this.styleStr=await this.styleStrPromise),e!==this.styleStr&&t.setAttribute("style",this.styleStr)}handleContainerMutations(t,e){t.forEach(t=>{this.params.container.querySelector(".ihm-watermark")||this.updateWatermarkStyle()})}handleWatermarkMutations(t,e){t.forEach(t=>{this.updateWatermarkStyle()})}async output(){await this.updateWatermarkStyle(),this.containerObserver.observe(this.params.container,{attributes:!0,childList:!0,characterData:!0})}destroy(){const t=this.params.container.querySelector(".ihm-watermark");t&&t.remove(),this.watermarkObserver.disconnect(),this.containerObserver.disconnect()}async update(t){t&&(this.params={...this.params,...t},Array.isArray(this.params.gap)&&2===this.params.gap.length||(this.params.gap=[0,0]),void 0===t.width&&null!==this.params.x&&void 0!==this.params.x||(this.params.x=null!==this.params.x&&void 0!==this.params.x?this.params.x:this.params.width/2),void 0===t.height&&null!==this.params.y&&void 0!==this.params.y||(this.params.y=null!==this.params.y&&void 0!==this.params.y?this.params.y:this.params.height/2),this.styleStrPromise=this.generateStyle(),this.styleStr=await this.styleStrPromise,await this.updateWatermarkStyle())}}function i(t){return new a(t)}window.ihmWaterMark=i;e.default=i}]).default}));