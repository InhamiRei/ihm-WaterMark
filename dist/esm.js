!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.createPoster=e():t.createPoster=e()}(window,(function(){return function(t){var e={};function r(a){if(e[a])return e[a].exports;var s=e[a]={i:a,l:!1,exports:{}};return t[a].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)r.d(a,s,function(e){return t[e]}.bind(null,s));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);class a{constructor(t){if(!t||!t.container)throw new Error("The 'container' parameter is required and must be a valid DOM element.");if(e=t.container,!("object"==typeof HTMLElement?e instanceof HTMLElement:e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName))throw new Error("The 'container' parameter must be a valid DOM element.");var e;const r={container:t.container,width:120,height:64,content:"",image:null,rotate:-22,zIndex:2025,opacity:.5,gap:[100,100],offset:null,font:{color:"rgba(0,0,0,0.15)",fontSize:16,fontWeight:"normal",fontFamily:"sans-serif",fontStyle:"normal",textAlign:"center"}};let a={...t};t.font&&(a.font={...r.font,...t.font}),this.params={...r,...a},Array.isArray(this.params.gap)&&2===this.params.gap.length||(this.params.gap=[100,100]),this.params.offset&&Array.isArray(this.params.offset)&&2===this.params.offset.length||(this.params.offset=[this.params.gap[0]/2,this.params.gap[1]/2]),this.watermarkX=this.params.width/2,this.watermarkY=this.params.height/2,this.styleStrPromise=this.generateStyle(),this.styleStr="",this.containerObserver=new MutationObserver(this.handleContainerMutations.bind(this)),this.watermarkObserver=new MutationObserver(this.handleWatermarkMutations.bind(this)),this.styleStrPromise.then(t=>{this.styleStr=t})}async generateStyle(){const t=this.params.width+this.params.gap[0],e=this.params.height+this.params.gap[1],r=await Promise.resolve(this.toDataURL());return`\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      z-index: ${this.params.zIndex};\n      pointer-events: none;\n      background-repeat: repeat;\n      background-position: ${this.params.offset[0]}px ${this.params.offset[1]}px;\n      background-size: ${t}px ${e}px;\n      background-image: url('${r}');\n    `}toDataURL(){const{width:t,height:e,rotate:r,content:a,opacity:s,gap:i,image:n,font:o}=this.params,h=this.watermarkX,l=this.watermarkY,m=document.createElement("canvas");m.width=t+i[0],m.height=e+i[1];const p=m.getContext("2d");if(!p)return"";p.clearRect(0,0,m.width,m.height),p.textBaseline="top",p.textAlign=o.textAlign||"center",p.fillStyle=o.color,p.globalAlpha=s;const c=`${o.fontStyle} ${o.fontWeight} ${o.fontSize}px ${o.fontFamily}`;return p.font=c,n?new Promise(e=>{const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{const a=i.width/i.height,s=Math.min(.8*t,i.width),n=s/a;p.restore(),p.save(),p.translate(h,l),p.rotate(Math.PI/180*r),p.drawImage(i,-s/2,-n/2,s,n),p.restore(),e(m.toDataURL())},i.onerror=()=>{p.clearRect(0,0,m.width,m.height),p.textBaseline="top",p.textAlign=o.textAlign||"center",p.fillStyle=o.color,p.globalAlpha=s,p.font=c,this.renderTextWatermark(p,a,h,l,o.fontSize),e(m.toDataURL())},i.src=n}):(this.renderTextWatermark(p,a,h,l,o.fontSize),m.toDataURL())}renderTextWatermark(t,e,r,a,s){if(t.save(),t.setTransform(1,0,0,1,0,0),t.translate(r,a),t.rotate(Math.PI/180*this.params.rotate),Array.isArray(e)){const r=1.5*s,a=-(r*(e.length-1))/2;e.forEach((e,s)=>{const i=a+r*s;"center"===t.textAlign?t.fillText(e,0,i):t.fillText(e,-t.measureText(e).width/2,i)})}else"center"===t.textAlign?t.fillText(e,0,-s/2):t.fillText(e,-t.measureText(e).width/2,-s/2);t.restore()}getOrCreateWatermarkDom(){let t=this.params.container.querySelector(".ihm-watermark");return t||(t=document.createElement("div"),t.setAttribute("class","ihm-watermark"),this.params.container.style.position="relative",this.params.container.insertBefore(t,this.params.container.firstChild),this.watermarkObserver.observe(t,{attributes:!0,childList:!0,subtree:!0})),t}async updateWatermarkStyle(){const t=this.getOrCreateWatermarkDom(),e=t.getAttribute("style");this.styleStr||(this.styleStr=await this.styleStrPromise),e!==this.styleStr&&t.setAttribute("style",this.styleStr)}handleContainerMutations(t,e){t.forEach(t=>{this.params.container.querySelector(".ihm-watermark")||this.updateWatermarkStyle()})}handleWatermarkMutations(t,e){t.forEach(t=>{this.updateWatermarkStyle()})}async output(){await this.updateWatermarkStyle(),this.containerObserver.observe(this.params.container,{attributes:!0,childList:!0,characterData:!0})}destroy(){const t=this.params.container.querySelector(".ihm-watermark");t&&t.remove(),this.watermarkObserver.disconnect(),this.containerObserver.disconnect()}async update(t){t&&(t.font&&(this.params.font={...this.params.font,...t.font},delete t.font),this.params={...this.params,...t},Array.isArray(this.params.gap)&&2===this.params.gap.length||(this.params.gap=[100,100]),this.params.offset&&Array.isArray(this.params.offset)&&2===this.params.offset.length||(this.params.offset=[this.params.gap[0]/2,this.params.gap[1]/2]),this.watermarkX=this.params.width/2,this.watermarkY=this.params.height/2,this.styleStrPromise=this.generateStyle(),this.styleStr=await this.styleStrPromise,await this.updateWatermarkStyle())}}function s(t){return new a(t)}window.ihmWaterMark=s;e.default=s}]).default}));